# Configuration

The `servers` directory contains all of the human-managed per-server
configuration. The `data` directory contains all state which is
automatically updated by servers.

## `servers`

Each server shall have two file entries here. `«name».json` (optional)
and `«name».crt`.

`«name»` is a friendly name for the server. This is used as the name
of the link block in the generated configs.

`«name».crt` is the PEM-encoded certificate authorizing updates
generated by running `client-gen-cert.sh` on the client. This is used
to authenticate any requests made by the client to this service and
determine which client is making the request. The idea is that these
certificates will only ever be created once per server. They are
self-signed and are just like an “API key” or “cookie” used by the
client to identify itself to this service.

`«name».json` is a JSON encoded configuration for the
server. Currently, the following keys are allowed:

* `hostname`: The hostname of the server (defaults to `«name»`).

## `data`

To populate this initially, run the client update script on each
client.

`updated` may be touched in the `data` directory to cause the process
to exit (in case you cannot run `kill(1)` yourself). In the future it
may do this in a more graceful way.

# Apache Configuration

For the directory where this is deployed, the following configuration
is required:

```apache
# Allow things to read client certs but do not rely on CAs for stuff.
SSLVerifyClient optional_no_ca
# Export the client certificate to the environment so that it can be verified by the CGI scripts.
SSLOptions +ExportCertData

# You must have FastCGI set up, e.g., mod_fcgid, to serve
# exeutables ending in .cgi. It is recommended to use either
# mod_suexec or an appliance VM (not shown):
<Directory /home/*/public_html>
  # Do not use AddHandler because it matches files like
  # blah.cgi.en (or blah.cgi.i_do_not_want_this_to_execute).
  <FilesMatch "\.cgi$">
    SetHandler fcgid-script
    Options +ExecCGI
  </FilesMatch>
</Directory>
```
